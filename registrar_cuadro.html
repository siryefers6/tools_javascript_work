<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRUD Cuadros</title>
    <script src="dexie.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <div class="flex justify-center my-6">
      <a
        href="index.html"
        class="bg-gray-600 text-white px-5 py-3 rounded-lg hover:bg-gray-700 transition duration-300 shadow-md"
      >
        ← Volver a la Página Principal
      </a>
    </div>

    <div class="max-w-6xl mx-auto p-6 bg-white rounded-lg shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-gray-800">CRUD local-first</h1>
        <button
          id="btnNuevo"
          type="button"
          hx-on="click: limpiarFormulario()"
          class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
        >
          Nuevo
        </button>
      </div>

      <form id="cuadroForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="cuadroId" />

        <div class="md:col-span-2">
          <h2 class="text-xl font-semibold text-gray-700">Cliente</h2>
        </div>
        <div>
          <label for="nombres" class="block">Nombres</label>
          <input
            type="text"
            id="nombres"
            required
            class="border border-gray-300 p-3 rounded-lg w-full"
          />
        </div>
        <div>
          <label for="apellidos" class="block">Apellidos</label>
          <input
            type="text"
            id="apellidos"
            class="border border-gray-300 p-3 rounded-lg w-full"
          />
        </div>
        <div class="md:col-span-2">
          <label for="whatsapp" class="block">Whatsapp</label>
          <input
            type="text"
            id="whatsapp"
            required
            class="border border-gray-300 p-3 rounded-lg w-full"
          />
        </div>

        <div class="md:col-span-2">
          <h2 class="text-xl font-semibold text-gray-700">Cuadro</h2>
        </div>
        <div class="md:col-span-2">
          <label for="titulo" class="block">Titulo</label>
          <input
            type="text"
            id="titulo"
            required
            class="border border-gray-300 p-3 rounded-lg w-full"
          />
        </div>
        <div>
          <label for="tamanio" class="block">Tamano (cm)</label>
          <input
            type="text"
            id="tamanio"
            required
            placeholder="Ejemplo: 120X80"
            class="border border-gray-300 p-3 rounded-lg w-full"
          />
        </div>
        <div>
          <label for="categoria" class="block">Categoria</label>
          <select
            id="categoria"
            required
            class="border border-gray-300 p-3 rounded-lg w-full"
          >
            <option value="" disabled selected>Seleccione una categoria</option>
            <option value="oleo">Oleo</option>
            init();
          </script>
        </body>
      </html>

      function limpiarFormulario() {
        form.reset();
        cuadroIdInput.value = "";
        btnGuardar.textContent = "Guardar";
        setEstado("Formulario limpio.");
        history.replaceState({}, "", "registrar_cuadro.html");
      }

      function getFormData() {
        return {
          nombres: nombresInput.value.trim(),
          apellidos: apellidosInput.value.trim(),
          whatsapp: whatsappInput.value.trim(),
          titulo: tituloInput.value.trim(),
          tamanio: tamanioInput.value.trim(),
          categoria: categoriaInput.value,
          fecha_inicio: fechaInicioInput.value,
          valor_final: valorFinalInput.value
            ? Number(valorFinalInput.value)
            : null,
          updatedAt: new Date().toISOString(),
        };
      }

      async function renderTabla() {
        const tbody = document.querySelector("#tablaCuadros tbody");
        const cuadros = await db.cuadros.orderBy("updatedAt").reverse().toArray();
        tbody.innerHTML = "";

        cuadros.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p-2 border">${c.id}</td>
            <td class="p-2 border">${c.titulo || ""}</td>
            <td class="p-2 border">${c.nombres || ""} ${c.apellidos || ""}</td>
            <td class="p-2 border">${c.tamanio || ""}</td>
            <td class="p-2 border">${c.categoria || ""}</td>
            <td class="p-2 border">${c.valor_final ?? ""}</td>
            <td class="p-2 border text-center">
              <button
                class="bg-yellow-500 text-white px-3 py-1 rounded mr-2"
                data-id="${c.id}"
              >Editar</button>
              <button
                class="bg-red-600 text-white px-3 py-1 rounded"
                data-id="${c.id}"
              >Eliminar</button>
            </td>
          `;
          tr.querySelector("button.bg-yellow-500").addEventListener(
            "click",
            () => cargarCuadro(c.id),
          );
          tr.querySelector("button.bg-red-600").addEventListener("click", () =>
            borrarCuadro(c.id),
          );
          tbody.appendChild(tr);
        });

        if (!cuadros.length) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="7" class="p-4 text-center text-gray-500">Sin registros</td>';
          tbody.appendChild(tr);
        }
      }

      async function cargarCuadro(id) {
        const cuadro = await db.cuadros.get(id);
        if (!cuadro) {
          setEstado("No se encontro el cuadro.", "error");
          return;
        }
        cuadroIdInput.value = cuadro.id;
        nombresInput.value = cuadro.nombres || "";
        apellidosInput.value = cuadro.apellidos || "";
        whatsappInput.value = cuadro.whatsapp || "";
        tituloInput.value = cuadro.titulo || "";
        tamanioInput.value = cuadro.tamanio || "";
        categoriaInput.value = cuadro.categoria || "";
        fechaInicioInput.value = cuadro.fecha_inicio || "";
        valorFinalInput.value = cuadro.valor_final ?? "";
        btnGuardar.textContent = "Actualizar";
        setEstado(`Editando cuadro #${cuadro.id}`);
      }

      async function borrarCuadro(id) {
        const confirmar = confirm("Eliminar este cuadro?");
        if (!confirmar) return;
        await db.cuadros.delete(id);
        if (cuadroIdInput.value && Number(cuadroIdInput.value) === id) {
          limpiarFormulario();
        }
        setEstado("Cuadro eliminado.", "ok");
        renderTabla();
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const data = getFormData();

        if (!data.nombres || !data.whatsapp || !data.titulo) {
          setEstado("Completa los campos obligatorios.", "error");
          return;
        }

        if (cuadroIdInput.value) {
          const id = Number(cuadroIdInput.value);
          await db.cuadros.update(id, data);
          setEstado("Cuadro actualizado.", "ok");
        } else {
          await db.cuadros.add(data);
          setEstado("Cuadro guardado.", "ok");
        }

        limpiarFormulario();
        renderTabla();
      });

      async function init() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        await renderTabla();
        if (id) {
          await cargarCuadro(Number(id));
        }
      }

      init();
          await db.clientes.update(estado.clienteId, clienteData);
  </body>
</html>

        // Si es nuevo, intentamos reutilizar por whatsapp.
        const existente = await db.clientes
          .where("whatsapp")
          .equals(clienteData.whatsapp)
          .first();

        if (existente) {
          await db.clientes.update(existente.id, clienteData);
          return existente.id;
        }

        // Si no existe, lo creamos y devolvemos su ID.
        return await db.clientes.add(clienteData);
      }

      // ------------------------------------------
      // 7) Guardar cuadro (crear o actualizar)
      // ------------------------------------------
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Primero nos aseguramos de tener un cliente creado.
        const clienteId = await upsertCliente();

        // Armamos el objeto cuadro con todos los datos.
        const cuadroData = {
          clienteId,
          titulo: tituloInput.value.trim(),
          descripcion: descripcionInput.value.trim(),
          tamanio: tamanioInput.value.trim(),
          materiales: materialesInput.value.trim(),
          categoria: categoriaInput.value,
          fecha_inicio: fechaInicioInput.value,
          fecha_finalizacion: fechaFinalizacionInput.value,
          tiempo_invertido: parseFloat(tiempoInvertidoInput.value) || 0,
          detalle: parseInt(detalleInput.value, 10) || 0,
          creatividad: parseInt(creatividadInput.value, 10) || 0,
          complejidad_tecnica: parseInt(complejidadTecnicaInput.value, 10) || 0,
          valor_hora: parseFloat(valorHoraInput.value) || 0,
          valor_marco: parseFloat(valorMarcoInput.value) || 0,
          valor_materiales: parseFloat(valorMaterialesInput.value) || 0,
          valor_dibujo: parseFloat(valorDibujoInput.value) || 0,
          valor_sugerido: parseFloat(valorSugeridoInput.value) || 0,
          valor_final: parseFloat(valorFinalInput.value) || 0,
          creadoEn: estado.creadoEn || new Date().toISOString(),
          actualizadoEn: new Date().toISOString(),
        };

        // Si hay cuadroId, actualizamos. Si no, creamos uno nuevo.
        if (estado.cuadroId) {
          await db.cuadros.update(estado.cuadroId, cuadroData);
          alert("Cuadro actualizado");
        } else {
          await db.cuadros.add(cuadroData);
          alert("Cuadro creado");
        }

        // Limpiamos para dejar el formulario listo para un nuevo registro.
        limpiarFormulario();
      });

      // ------------------------------------------
      // 8) Cargar cuadro si viene ?id= en la URL
      // ------------------------------------------
      async function cargarEdicionDesdeURL() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        if (!id) return;

        // Buscamos el cuadro y su cliente asociado.
        const cuadro = await db.cuadros.get(Number(id));
        if (!cuadro) return;
        const cliente = await db.clientes.get(cuadro.clienteId);

        // Cargamos todo en el formulario.
        cargarFormulario(cuadro, cliente);
      }

      // ------------------------------------------
      // 9) Boton "Nuevo" para limpiar rapido
      // ------------------------------------------
      btnNuevo.addEventListener("click", limpiarFormulario);

      // ------------------------------------------
      // 10) Ejecutar al cargar la pagina
      // ------------------------------------------
      cargarEdicionDesdeURL();
    </script>
  </body>
</html>
